<!DOCTYPE html>
<!-- The document type declaration for HTML5 -->
<html>
  <head>
    <!-- Set character encoding to UTF-8 -->
    <meta charset="utf-8" />
    <!-- Make the page responsive on all devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Page title -->
    <title>Bounty Office</title>
    <!-- Internal CSS styles for layout and appearance -->
    <style>
      /* CSS Variables for consistent theming */
      :root {
        --bg-primary: #0f1115;
        --bg-secondary: #14151c;
        --bg-tertiary: #181922;
        --border-color: #232333;
        --text-primary: #e9e9ee;
        --text-secondary: #aaa;
        --text-accent: #9aa;
        --accent-color: #ffb300;
        --danger-color: #ff2d2d;
        --success-color: #4caf50;
        --button-bg: #1b1b25;
        --button-hover: #20212a;
        --button-disabled: #2b2b3a;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        --border-radius: 12px;
        --border-radius-sm: 8px;
        --spacing-xs: 8px;
        --spacing-sm: 12px;
        --spacing-md: 16px;
        --spacing-lg: 18px;
        --spacing-xl: 24px;
        --spacing-2xl: 32px;
        --font-size-sm: 13px;
        --font-size-base: 15px;
        --font-size-lg: 18px;
        --font-size-xl: 20px;
        --font-size-2xl: 26px;
        --font-size-3xl: 32px;
      }

      /* Reset and base styles */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.5;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }

      /* Responsive container */
      .container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--spacing-md);
      }

      /* Header section */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
        position: relative;
      }

      .header-left {
        flex: 1;
        min-width: 0;
      }

      .header-right {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        align-items: flex-end;
        flex-shrink: 0;
      }

      .title {
        font-size: var(--font-size-3xl);
        font-weight: 700;
        margin: 0;
        color: var(--text-primary);
      }

      /* Control buttons */
      .control-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
        background: var(--button-bg);
        color: var(--text-primary);
        cursor: pointer;
        font-size: var(--font-size-sm);
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
        min-height: 40px; /* Minimum touch target size */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .control-btn:hover {
        background: var(--button-hover);
        transform: translateY(-1px);
      }

      .control-btn.danger {
        background: var(--danger-color);
        border-color: var(--danger-color);
      }

      .control-btn.danger:hover {
        background: #e02424;
      }

      .control-btn.active {
        background: var(--button-disabled);
      }

      .last-saved {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
        text-align: right;
      }

      /* Main grid layout */
      .main-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-2xl);
      }

      /* Save/Reset controls positioned at bottom right */
      .save-controls {
        position: fixed;
        bottom: var(--spacing-lg);
        right: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        z-index: 1000;
      }

      .save-controls .control-btn {
        min-width: 140px;
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: var(--font-size-sm);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow);
      }

      /* Responsive grid breakpoints */
      @media (min-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr 1fr;
          gap: var(--spacing-lg);
        }
      }

      @media (min-width: 1024px) {
        .main-grid {
          grid-template-columns: 280px 1fr 280px;
          gap: var(--spacing-xl);
        }
      }

      @media (min-width: 1400px) {
        .main-grid {
          grid-template-columns: 320px 1fr 320px;
          gap: var(--spacing-2xl);
        }
      }

      /* Card component */
      .card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
      }

      .card-header {
        margin-bottom: var(--spacing-lg);
      }

      .card-title {
        font-size: var(--font-size-2xl);
        font-weight: 600;
        margin: 0;
        color: var(--text-primary);
      }

      /* Main game area */
      .game-area {
        order: 1;
      }

      @media (min-width: 768px) {
        .game-area {
          order: 2;
        }
      }

      /* Sidebar areas */
      .sidebar-left {
        order: 2;
      }

      .sidebar-right {
        order: 3;
      }

      @media (min-width: 768px) {
        .sidebar-left {
          order: 1;
        }
        .sidebar-right {
          order: 3;
        }
      }

      /* Row layout for items */
      .row {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        flex-wrap: wrap;
      }

      .row:last-child {
        margin-bottom: 0;
      }

      /* Button styles */
      .btn {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
        background: var(--button-bg);
        color: var(--text-primary);
        cursor: pointer;
        font-size: var(--font-size-base);
        font-weight: 500;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        white-space: nowrap;
        min-height: 44px; /* Minimum touch target size */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }

      .btn:hover:not(:disabled) {
        background: var(--button-hover);
        transform: translateY(-1px);
      }

      .btn:disabled {
        opacity: 0.65;
        cursor: not-allowed;
        background: var(--button-disabled);
      }

      .btn:disabled:hover {
        transform: none;
      }

      .btn.primary {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: #000;
        font-weight: 600;
      }

      .btn.primary:hover:not(:disabled) {
        background: #e6a200;
      }

      /* Cooldown overlay */
      .cooldownable::after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: var(--cdw, 0%);
        background: linear-gradient(90deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.12) 100%);
        transition: width 40ms linear;
        pointer-events: none;
      }

      /* Typography helpers */
      .num {
        font-variant-numeric: tabular-nums;
        font-weight: 600;
      }

      .text-secondary {
        color: var(--text-secondary);
        font-size: var(--font-size-sm);
      }

      .text-accent {
        color: var(--text-accent);
      }

      /* Upgrade rows */
      .upgrade-row {
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-sm);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
      }

      .upgrade-row:hover {
        background: var(--bg-secondary);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .upgrade-row.maxed {
        opacity: 0.6;
      }

      .upgrade-row.maxed:hover {
        transform: none;
        box-shadow: none;
      }

      .upgrade-info {
        margin-top: var(--spacing-xs);
        margin-left: var(--spacing-xs);
        line-height: 1.4;
      }

      /* Contracts section */
      .contracts-section {
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md);
        background: var(--bg-tertiary);
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--border-color);
      }

      .contracts-title {
        font-size: var(--font-size-xl);
        font-weight: 600;
        margin: 0 0 var(--spacing-sm) 0;
        color: var(--text-primary);
      }

      .contracts-hint {
        margin-bottom: var(--spacing-md);
        line-height: 1.6;
      }

      .contracts-warning {
        color: var(--accent-color);
        font-weight: 600;
      }

      /* Toast notifications */
      .toast {
        position: relative;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        padding: var(--spacing-sm) var(--spacing-xl);
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-base);
        opacity: 0;
        pointer-events: none;
        transition: all 0.5s ease;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        max-width: 300px;
        text-align: center;
        word-wrap: break-word;
        transform: translateY(10px);
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .toast.fade-out {
        opacity: 0;
        transform: translateY(10px);
      }

      /* Toast container for stacking */
      .toast-container {
        position: fixed;
        left: 50%;
        bottom: var(--spacing-2xl);
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-sm);
        pointer-events: none;
      }

      /* Mobile optimizations */
      @media (max-width: 767px) {
        .container {
          padding: var(--spacing-sm);
        }

        .header {
          flex-direction: column;
          align-items: stretch;
          gap: var(--spacing-sm);
        }

        .header-right {
          align-items: stretch;
          flex-direction: row;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: var(--spacing-xs);
        }

        .title {
          font-size: var(--font-size-2xl);
          text-align: center;
        }

        .control-btn {
          padding: var(--spacing-xs) var(--spacing-sm);
          font-size: var(--font-size-sm);
          flex: 1;
          min-width: 0;
        }

        .card {
          padding: var(--spacing-md);
        }

        .card-title {
          font-size: var(--font-size-xl);
        }

        .btn {
          padding: var(--spacing-sm);
          font-size: var(--font-size-sm);
        }

        .row {
          flex-direction: column;
          align-items: stretch;
          gap: var(--spacing-xs);
        }

        .upgrade-row {
          padding: var(--spacing-xs);
        }

        .upgrade-row-mobile .row {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
        }

        .upgrade-row .btn {
          flex: 1;
          margin-right: var(--spacing-sm);
          min-width: 0;
          white-space: normal;
          height: auto;
          line-height: 1.3;
        }

        .main-grid {
          gap: var(--spacing-md);
        }

        .toast-container {
          left: 20px;
          right: 20px;
          transform: none;
          bottom: var(--spacing-lg);
        }

        .toast {
          max-width: none;
          width: 100%;
        }
      }

      /* Small mobile devices */
      @media (max-width: 480px) {
        .container {
          padding: var(--spacing-xs);
        }

        .header-right {
          flex-direction: column;
          align-items: stretch;
          gap: var(--spacing-xs);
        }

        .control-btn {
          width: 100%;
          text-align: center;
          padding: var(--spacing-sm);
        }

        .card {
          padding: var(--spacing-sm);
        }

        .btn {
          width: 100%;
          text-align: center;
          padding: var(--spacing-sm);
        }

        .title {
          font-size: var(--font-size-xl);
        }

        .card-title {
          font-size: var(--font-size-lg);
        }

        .main-grid {
          gap: var(--spacing-sm);
        }

        .save-controls {
          position: fixed;
          bottom: var(--spacing-sm);
          right: var(--spacing-sm);
          left: var(--spacing-sm);
          flex-direction: row;
          justify-content: center;
        }

        .save-controls .control-btn {
          flex: 1;
          min-width: 0;
          padding: var(--spacing-sm);
        }
      }

      /* High DPI displays */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .card {
          /* Use box-shadow to simulate a thin border on high DPI displays */
          border-width: 1px;
          box-shadow: 0 0 0 0.5px var(--border-color, #e0e0e0);
        }
      }

      /* Dark mode support */
      @media (prefers-color-scheme: dark) {
        :root {
          --bg-primary: #0a0a0a;
          --bg-secondary: #0f0f0f;
          --bg-tertiary: #141414;
        }
      }

      /* Reduced motion support */
      @media (prefers-reduced-motion: reduce) {
        .btn,
        .control-btn {
          transition: none;
        }
        
        .btn:hover:not(:disabled) {
          transform: none;
        }
      }

      /* Focus styles for accessibility */
      .btn:focus,
      .control-btn:focus {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
      }

      /* Loading states */
      .loading {
        opacity: 0.7;
        pointer-events: none;
      }

      /* Success/error states */
      .success {
        border-color: var(--success-color);
      }

      .error {
        border-color: var(--danger-color);
      }

      /* Landscape mobile optimizations */
      @media (max-height: 500px) and (orientation: landscape) {
        .container {
          padding: var(--spacing-xs);
        }

        .header {
          margin-bottom: var(--spacing-sm);
        }

        .title {
          font-size: var(--font-size-xl);
        }

        .card {
          padding: var(--spacing-sm);
        }

        .card-title {
          font-size: var(--font-size-lg);
        }

        .main-grid {
          gap: var(--spacing-sm);
        }
      }

      /* Print styles */
      @media print {
        .control-btn,
        .btn {
          display: none;
        }

        .card {
          border: 1px solid #000;
          box-shadow: none;
        }
      }
    </style>
    <body>
    <!-- Toast notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
      <!-- Header section -->
      <header class="header">
        <div class="header-left">
          <!-- Title removed as requested -->
        </div>
        <div class="header-right">
          <div id="lastSaved" class="last-saved">Last saved just now</div>
        </div>
      </header>

      <!-- Main grid layout -->
      <main class="main-grid">
        <!-- Left sidebar: Crew -->
        <aside class="sidebar-left">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Crew</h2>
            </div>
            <div id="hireRow" style="display:none;">
              <div class="row">
                <button id="hireBtn" class="btn cooldownable" data-cooldown-type="hire">Hire Novice Hunter</button>
              </div>
              <div class="row">
                <span id="hireCostSpan" class="text-secondary">Cost: 20</span>
              </div>
              <div id="hirePerTick" class="text-accent">+0.5 credits/tick</div>
              <div id="hireCostBelow" class="text-secondary">Hired: 0</div>
            </div>
          </div>
        </aside>

        <!-- Main game area -->
        <section class="game-area">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Bounty Office</h2>
            </div>
            <div class="row">
              <span>Credits:</span>
              <strong class="num" id="credits">0</strong>
            </div>
            <div class="row">
              <button id="huntBtn" class="btn primary cooldownable action-btn" data-btn-type="action" data-cooldown-type="action">Hunt petty bounty</button>
              <span id="clickInfo" class="text-secondary">+1 credit</span>
            </div>
            <div class="row">
              <button id="contractClickBtn" class="btn cooldownable action-btn" data-btn-type="action" data-cooldown-type="action" style="display:none;">Advance contract</button>
            </div>
            <div class="row" style="display:none">
              <span>Ticks:</span>
              <strong class="num" id="ticks">0</strong>
            </div>
            <div class="row" style="display:none">
              <span>Unbanked:</span>
              <strong class="num" id="unbanked">0.0</strong>
            </div>
            
            <!-- Contracts section -->
            <div id="contractsBox" class="contracts-section" style="display:none;">
              <h3 class="contracts-title">Contracts</h3>
              <div id="contractsHint" class="contracts-hint">
                New contracts will appear here!<br>
                <span class="contracts-warning">WARNING: Contracts take a long time to fulfill!</span>
              </div>
              <div id="contractArea"></div>
            </div>
          </div>
        </section>

        <!-- Right sidebar: Upgrades -->
        <aside class="sidebar-right">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Upgrades</h2>
            </div>
            <div id="upgradeArea"></div>
          </div>
        </aside>
      </main>
      
      <!-- Save/Reset buttons moved to bottom right -->
      <div class="save-controls">
        <button id="manualSaveBtn" class="control-btn">Manual Save</button>
        <button id="autosaveToggleBtn" class="control-btn active">Autosave ON</button>
        <button id="resetBtn" class="control-btn danger">Reset Save</button>
      </div>
    </div>

    <!-- JavaScript for interactive functionality -->
    <script>
    // Save key for localStorage
    const SAVE_KEY = "bountySaveV1";
    // Base cooldown for hunt/actions (used for flat % reductions)
    const BASE_HUNT_COOLDOWN_MS = 1000;
    // Max purchases for reduce-cooldown: 20th removes cooldown entirely
    const REDUCE_CD_MAX_COUNT = 20;

    // Crew types data structure
    const crewTypes = [
      {
        id: "novice",
        name: "Novice Hunter",
        baseCost: 20,
        scaling: 1.15,
        perTick: 0.5,
        count: 0,
        revealed: false,
      },
      // Future crew types can be added here
    ];

    // Contracts data structure
    const contracts = [
      {
        id: "familiar-face",
        description: "A familiar face enters the office",
        details: "You meet an old friend who needs help with a bounty. Complete the contract to earn a hefty reward.",
        goal: 1000,
        reward: 2000,
      },
      // Add more contracts here!
    ];

    // Upgrade types data structure (scalable like crew types)
    const upgradeTypes = [
      {
        id: "reduceCooldown",
        name: "Reduce Cooldown",
        baseCost: 10,
        scaling: 1.15,
        description: "Reduces button click cooldown by 5%",
      },
      {
        id: "doubleClick",
        name: "Double Click Power",
        baseCost: 20,
        scaling: 2.5,
        description: "Multiplies click power by 2",
      },
      // Future upgrades can be added here
    ];

    // Game state
    const state = {
      credits: 0,
      ticks: 0,
      unbanked: 0,
      // Tracks which upgrades have been revealed at least once
      revealedUpgrades: {},
      // Shared button type multipliers
      buttonTypes: {
        // Action-type buttons: hunt, advance contract, etc.
        action: { base: 1, multiplier: 1 },
      },
      cooldowns: {
        action: { baseMs: BASE_HUNT_COOLDOWN_MS, ms: BASE_HUNT_COOLDOWN_MS, readyAt: 0 },
        hire: { baseMs: BASE_HUNT_COOLDOWN_MS, ms: BASE_HUNT_COOLDOWN_MS, readyAt: 0 },
      },
      upgrades: {}, // map of upgradeId -> count
      flags: {
        contractsUnlocked: false,
        contractsHintRemoved: false,
        upgradesRevealed: false,
      },
      contractActive: false,
      contractProgress: 0,
      currentContract: 0, // index in contracts array
    };

    const $ = id => document.getElementById(id);
    const fmt0 = n => n.toLocaleString(undefined, { maximumFractionDigits: 0 });
    const fmt1 = n => n.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 });

    // Calculate the cost for a crew type
    function getCrewCost(crew) {
      return Math.floor(crew.baseCost * Math.pow(crew.scaling, crew.count));
    }

    // Button type click value
    function getButtonValue(typeId) {
      const t = (state.buttonTypes && state.buttonTypes[typeId]) || { base: 1, multiplier: 1 };
      return (t.base || 1) * (t.multiplier || 1);
    }
    // Back-compat/shortcut for action type
    function getClickValue() {
      return getButtonValue('action');
    }

    // Generic upgrade cost calculation
    function getUpgradeCost(upgrade) {
      const count = (state.upgrades && state.upgrades[upgrade.id]) || 0;
      return Math.floor(upgrade.baseCost * Math.pow(upgrade.scaling, count));
    }

    // Recalculate cooldown from upgrades using flat -5% per purchase from base
    function updateCooldownFromUpgrades() {
      const count = (state.upgrades && state.upgrades.reduceCooldown) || 0;
      const linearFactor = count >= REDUCE_CD_MAX_COUNT ? 0 : Math.max(0, 1 - 0.05 * count);
      if (!state.cooldowns || typeof state.cooldowns !== 'object') return;
      const now = Date.now();
      for (const key of Object.keys(state.cooldowns)) {
        const cd = state.cooldowns[key];
        if (!cd) continue;
        const base = cd.baseMs || BASE_HUNT_COOLDOWN_MS;
        const oldMs = cd.ms || base;
        const newMs = linearFactor === 0 ? 0 : Math.max(100, Math.round(base * linearFactor));
        cd.ms = newMs;
        if (cd.readyAt && cd.readyAt > now) {
          if (newMs === 0) {
            cd.readyAt = now; // instantly ready
          } else {
            const remaining = cd.readyAt - now;
            const scaled = Math.round(remaining * (newMs / oldMs));
            cd.readyAt = now + Math.max(0, scaled);
          }
        }
      }
    }

    // Recalculate click multiplier from upgrades (2x per purchase)
    function updateClickPowerFromUpgrades() {
      if (!state.buttonTypes || !state.buttonTypes.action) {
        state.buttonTypes = { action: { base: 1, multiplier: 1 } };
      }
      const count = (state.upgrades && state.upgrades.doubleClick) || 0;
      state.buttonTypes.action.multiplier = Math.pow(2, count || 0);
    }

    function canClick(typeId) {
      const cd = (state.cooldowns && state.cooldowns[typeId]) || { readyAt: 0 };
      return Date.now() >= (cd.readyAt || 0);
    }

    function startCooldown(typeId) {
      if (!state.cooldowns || !state.cooldowns[typeId]) return;
      const cd = state.cooldowns[typeId];
      const dur = (cd.ms != null) ? cd.ms : BASE_HUNT_COOLDOWN_MS;
      cd.readyAt = Date.now() + dur;
      updateCooldownVisual();
    }
    // Back-compat wrappers
    function canHuntClick() { return canClick('action'); }
    function startHuntCooldown() { return startCooldown('action'); }

    function updateUI() {
      $("credits").textContent = fmt0(state.credits);
      $("ticks").textContent = fmt0(state.ticks);
      const u = document.getElementById("unbanked");
      if (u) u.textContent = fmt1(state.unbanked);

      // Novice Hunter UI
      const novice = crewTypes[0];
      const hireCostSpan = document.getElementById("hireCostSpan");
      const hireCostBelow = document.getElementById("hireCostBelow");
      if (hireCostSpan) {
        hireCostSpan.textContent = `Cost: ${getCrewCost(novice)}`;
      }
      if (hireCostBelow) {
        hireCostBelow.textContent = `Hired: ${novice.count}`;
      }
      const hirePerTick = document.getElementById("hirePerTick");
      if (hirePerTick) {
        if (novice.count === 0) {
          hirePerTick.innerHTML = `<span style='color:#9aa;'>+${novice.perTick}</span> credits/tick`;
        } else {
          const totalPerTick = (novice.count * novice.perTick).toFixed(1);
          hirePerTick.innerHTML = `<span style='color:#9aa;'>+${totalPerTick}</span> credits/tick`;
        }
      }
      const hireRow = document.getElementById("hireRow");
      if (hireRow) {
        if (novice.revealed || state.credits >= getCrewCost(novice)) {
          hireRow.style.display = "";
          novice.revealed = true;
        } else {
          hireRow.style.display = "none";
        }
      }
      // Update click info text and toggle contract click button
      const clickInfo = document.getElementById("clickInfo");
      if (clickInfo) {
        const val = getClickValue();
        clickInfo.textContent = `+${fmt0(val)} credit`;
      }
      const contractClickBtn = document.getElementById("contractClickBtn");
      if (contractClickBtn) {
        contractClickBtn.style.display = state.contractActive ? "" : "none";
      }

      // Upgrades UI
      const upgradeArea = document.getElementById("upgradeArea");
      if (upgradeArea) {
        // Render all upgrades
        let html = "";
        for (const up of upgradeTypes) {
          const cost = getUpgradeCost(up);
          const disabled = state.credits < cost ? "disabled" : "";
          // Extra info: for reduceCooldown, show net reduction
          let extra = "";
          if (up.id === 'reduceCooldown') {
            const count = (state.upgrades && state.upgrades[up.id]) || 0;
            const net = Math.min(100, 5 * count);
            extra = ` <span class="text-accent">• Net: ${net}%</span>`;
          }
          // Determine maxed state (for reduceCooldown)
          let isMaxed = false;
          if (up.id === 'reduceCooldown') {
            const count = (state.upgrades && state.upgrades[up.id]) || 0;
            isMaxed = count >= REDUCE_CD_MAX_COUNT;
          }
          const count = (state.upgrades && state.upgrades[up.id]) || 0;
          const alreadyRevealed = !!(state.revealedUpgrades && state.revealedUpgrades[up.id]);
          const shouldShow = alreadyRevealed || count > 0 || state.credits >= up.baseCost;
          if (!shouldShow) continue;
          // Mark as revealed permanently once shown the first time
          if (!alreadyRevealed) {
            if (!state.revealedUpgrades) state.revealedUpgrades = {};
            state.revealedUpgrades[up.id] = true;
            try { save(); } catch {}
          }
          const maxedClass = isMaxed ? "maxed" : "";
          const mobileClass = window.innerWidth <= 768 ? "upgrade-row-mobile" : "";
          html += `<div class="upgrade-row ${maxedClass} ${mobileClass}">
            <div class="row">
              <button class="btn" data-upgrade-id='${up.id}' ${disabled} ${isMaxed ? "disabled" : ""}>${isMaxed ? (up.name + ' (Max)') : up.name}</button>
              <span class="text-secondary">${isMaxed ? '' : `Cost: ${cost}`}</span>
            </div>
            <div class="upgrade-info text-secondary">${up.description}${extra}</div>
          </div>`;
        }
        upgradeArea.innerHTML = html;
      }
      // Contracts box logic (flag system, any crew type >= 10)
      const contractsBox = document.getElementById("contractsBox");
      const contractArea = document.getElementById("contractArea");
      if (contractsBox) {
        // Unlock when condition met, otherwise respect saved flag
        if (!state.flags.contractsUnlocked && crewTypes.some(c => c.count >= 10)) {
          state.flags.contractsUnlocked = true;
          // Persist immediately so refresh keeps it
          try { save(); } catch {}
          // Show one-time toast when contracts unlock
          showToast("Contracts unlocked!");
        }

        if (state.flags.contractsUnlocked) {
          contractsBox.style.display = "";
          // Hide hint permanently once first contract is taken
          const contractsHint = document.getElementById("contractsHint");
          if (contractsHint) {
            if (state.flags.contractsHintRemoved) {
              contractsHint.remove();
            }
          }
          // Contract UI
          if (contractArea) {
            const contract = contracts[state.currentContract];
            if (!state.contractActive) {
              contractArea.innerHTML = `<div class="row" style="margin-top: 12px;">
                <button id='takeContractBtn' class='btn cooldownable' data-cooldown-type='action'>Take Contract</button>
                <span class="text-secondary">${contract.description}</span>
              </div>`;
            } else {
              contractArea.innerHTML = `<div style='margin-top: 12px;'>
                <div style='margin-bottom: 8px;'>${contract.details}</div>
                <div>Progress: <strong id='contractProgressNum'>${state.contractProgress}</strong> / ${contract.goal}</div>
              </div>`;
            }
          }
        } else {
          contractsBox.style.display = "none";
        }
      }
    }

    // Actions
    $("huntBtn").addEventListener("click", () => {
      if (!canClick('action')) return;
      state.credits += getClickValue();
      startCooldown('action');
      updateUI();
    });

    const hireBtn = document.getElementById("hireBtn");
    if (hireBtn) {
      hireBtn.addEventListener("click", () => {
        if (!canClick('hire')) return;
        const novice = crewTypes[0];
        const cost = getCrewCost(novice);
        if (state.credits < cost) return;
        state.credits -= cost;
        novice.count += 1;
        startCooldown('hire');
        updateUI();
      });
    }

    // Contract click button: contributes click value to contract progress
    const contractClickBtn = document.getElementById("contractClickBtn");
    if (contractClickBtn) {
      contractClickBtn.addEventListener("click", () => {
        if (!canClick('action')) return;
        if (!state.contractActive) return;
        const add = getClickValue();
        const contract = contracts[state.currentContract];
        state.contractProgress += add;
        if (state.contractProgress >= contract.goal) {
          state.contractProgress = contract.goal;
          // Complete contract immediately on click
          state.credits += contract.reward;
          state.contractActive = false;
          state.contractProgress = 0;
        }
        // Update progress number live if visible
        const progressNum = document.getElementById('contractProgressNum');
        if (progressNum) progressNum.textContent = state.contractProgress;
        startCooldown('action');
        updateUI();
      });
    }

    // Upgrades: generic delegated purchase handler
    document.addEventListener('click', function(e) {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const upId = target.getAttribute('data-upgrade-id');
      if (!upId) return;
      const up = upgradeTypes.find(u => u.id === upId);
      if (!up) return;
      // Prevent purchases when maxed (reduceCooldown)
      if (upId === 'reduceCooldown') {
        const count = (state.upgrades && state.upgrades.reduceCooldown) || 0;
        if (count >= REDUCE_CD_MAX_COUNT) return;
      }
      const cost = getUpgradeCost(up);
      if (state.credits < cost) return;
      state.credits -= cost;
      state.upgrades[up.id] = (state.upgrades[up.id] || 0) + 1;
      // Ensure revealed flag persists once purchased
      if (!state.revealedUpgrades) state.revealedUpgrades = {};
      state.revealedUpgrades[up.id] = true;
      // Apply upgrade effect
      applyUpgradeEffect(up.id);
      try { save(); } catch {}
      updateUI();
      showToast(`Upgrade purchased: ${up.name}`);
    });

    function applyUpgradeEffect(id) {
      switch (id) {
        case 'reduceCooldown': {
          // Apply flat -5% per purchase from base cooldown
          updateCooldownFromUpgrades();
          break;
        }
        case 'doubleClick': {
          updateClickPowerFromUpgrades();
          break;
        }
        default:
          break;
      }
    }

    // Tick and banking
    const TICK_MS = 1000;
    const tickId = setInterval(() => {
      state.ticks += 1;

      // If contract is active, increment contract progress instead of credits
      if (state.contractActive) {
        const contract = contracts[state.currentContract];
        let contractPerTick = 0;
        for (const crew of crewTypes) {
          contractPerTick += crew.count * crew.perTick;
        }
        state.contractProgress += contractPerTick;
        // Clamp progress
        if (state.contractProgress >= contract.goal) {
          state.contractProgress = contract.goal;
          // Award credits and end contract
          state.credits += contract.reward;
          state.contractActive = false;
          state.contractProgress = 0;
        }
      } else {
        // Calculate passive income from all crew
        let passivePerTick = 0;
        for (const crew of crewTypes) {
          passivePerTick += crew.count * crew.perTick;
        }
        state.unbanked += passivePerTick;

        // Bank only whole credits
        const whole = Math.floor(state.unbanked);
        if (whole > 0) {
          state.credits += whole;
          state.unbanked -= whole;
        }
      }

      updateUI();
      // Update contract progress UI if active
      if (state.contractActive) {
        const progressNum = document.getElementById('contractProgressNum');
        if (progressNum) progressNum.textContent = state.contractProgress;
      }
    }, TICK_MS);
    // Take Contract button event (delegated)
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'takeContractBtn') {
        if (!canClick('action')) return;
        state.contractActive = true;
        state.contractProgress = 0;
        // Permanently remove hint after first contract is taken
        state.flags.contractsHintRemoved = true;
        const hintEl = document.getElementById('contractsHint');
        if (hintEl) { try { hintEl.remove(); } catch {} }
        try { save(); } catch {}
        startCooldown('action');
        updateUI();
      }
    });

    // Persistence
    let suppressSaves = false;

    function save() {
      if (suppressSaves) return;
      // Save both state and crewTypes
      localStorage.setItem(SAVE_KEY, JSON.stringify({ state, crewTypes }));
    }

    function load() {
      const raw = localStorage.getItem(SAVE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        Object.assign(state, data.state || {});
        if (Array.isArray(data.crewTypes)) {
          for (let i = 0; i < crewTypes.length; ++i) {
            Object.assign(crewTypes[i], data.crewTypes[i]);
          }
        }
        // Ensure upgrades is an object map
        if (!state.upgrades || typeof state.upgrades !== 'object') state.upgrades = {};
        // Ensure revealedUpgrades map exists
        if (!state.revealedUpgrades || typeof state.revealedUpgrades !== 'object') {
          state.revealedUpgrades = {};
        }
        // Ensure buttonTypes exists
        if (!state.buttonTypes || typeof state.buttonTypes !== 'object') {
          state.buttonTypes = { action: { base: 1, multiplier: 1 } };
        } else if (!state.buttonTypes.action) {
          state.buttonTypes.action = { base: 1, multiplier: 1 };
        }
        // Ensure cooldowns structure exists and migrate legacy fields
        if (!state.cooldowns || typeof state.cooldowns !== 'object') {
          state.cooldowns = {
            action: { baseMs: BASE_HUNT_COOLDOWN_MS, ms: BASE_HUNT_COOLDOWN_MS, readyAt: 0 },
            hire: { baseMs: BASE_HUNT_COOLDOWN_MS, ms: BASE_HUNT_COOLDOWN_MS, readyAt: 0 },
          };
        }
        if (typeof state.huntCooldownMs === 'number') {
          // legacy field; map to action.ms (will be recalculated anyway)
          state.cooldowns.action.ms = state.huntCooldownMs;
          delete state.huntCooldownMs;
        }
        if (typeof state.huntReadyAt === 'number') {
          state.cooldowns.action.readyAt = state.huntReadyAt;
          delete state.huntReadyAt;
        }
        // Migrations from earlier structures
        if (state.upgrades && state.upgrades.reduceCooldownPurchased && state.upgrades.reduceCooldown == null) {
          state.upgrades.reduceCooldown = 1;
          delete state.upgrades.reduceCooldownPurchased;
          state.flags.upgradesRevealed = true;
        }
        if (state.upgrades && state.upgrades.reduceCooldownCount != null) {
          state.upgrades.reduceCooldown = state.upgrades.reduceCooldownCount;
          delete state.upgrades.reduceCooldownCount;
          state.flags.upgradesRevealed = true;
        }
        // Migration: old clickMultiplier -> action button type multiplier
        if (typeof state.clickMultiplier === 'number') {
          state.buttonTypes.action.multiplier = state.clickMultiplier;
          delete state.clickMultiplier;
        }
        // Ensure cooldown matches flat reductions from upgrades
        updateCooldownFromUpgrades();
        // Ensure click power multiplier reflects upgrades
        updateClickPowerFromUpgrades();
      } catch {}
    }

    // Track last save time
    let lastSaveTime = Date.now();

    // Load once, then autosave every 30s
    load();
    updateUI();
    // Ensure cooldown reflects saved/initial state
    updateCooldownFromUpgrades();
    updateClickPowerFromUpgrades();
    updateCooldownVisual();
    function updateLastSaved() {
      const el = document.getElementById("lastSaved");
      if (!el) return;
      const secs = Math.floor((Date.now() - lastSaveTime) / 1000);
      el.textContent = secs === 0 ? "Last saved just now" : `Last saved ${secs} seconds ago`;
    }
    setInterval(updateLastSaved, 1000);



    // Toast management system
    let toastCounter = 0;
    const toastContainer = document.getElementById("toastContainer");
    const MAX_TOASTS = 5; // Maximum number of toasts to show at once

    // Helper function to safely create and show toasts with error handling
    function createToastSafely(message, type = "info") {
      try {
        // Check if toast container is available
        if (!toastContainer) {
          console.warn("Toast container not available, skipping toast:", message);
          return null;
        }

        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        toast.dataset.toastId = ++toastCounter;
        
        // Add type-specific styling
        if (type === "autosave") {
          toast.style.borderLeft = "4px solid var(--accent-color)";
        } else if (type === "manual-save") {
          toast.style.borderLeft = "4px solid var(--success-color)";
        }
        
        // Add to container
        toastContainer.appendChild(toast);
        
        // Remove oldest toast if we exceed the maximum
        const toasts = toastContainer.querySelectorAll('.toast');
        if (toasts.length > MAX_TOASTS) {
          const oldestToast = toasts[0];
          oldestToast.classList.add("fade-out");
          setTimeout(() => {
            if (oldestToast.parentNode) {
              oldestToast.parentNode.removeChild(oldestToast);
            }
          }, 300);
        }
        
        // Show toast
        requestAnimationFrame(() => {
          toast.classList.add("show");
        });
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          toast.classList.add("fade-out");
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 500);
        }, 3000);
        
        // Also remove if user navigates away
        const observer = new MutationObserver(() => {
          if (!toast.parentNode) {
            observer.disconnect();
          }
        });
        observer.observe(document.body, { childList: true, subtree: true });
        
        return toast;
      } catch (error) {
        console.error("Failed to create toast:", error);
        return null;
      }
    }

    // Legacy function for backward compatibility
    function createToast(message, type = "info") {
      return createToastSafely(message, type);
    }

    function showAutosaveToast() {
      createToastSafely("Game autosaved!", "autosave");
    }

    function showManualSaveToast() {
      createToastSafely("Game manually saved!", "manual-save");
    }

    // Generic toast helper
    function showToast(message) {
      createToastSafely(message, "info");
    }

    // Smoothly update hunt cooldown visual and disabled state
    function updateCooldownVisual() {
      const now = Date.now();
      const btns = document.querySelectorAll('button.cooldownable');
      let anyCooling = false;
      for (const b of btns) {
        const type = b.getAttribute('data-cooldown-type') || 'action';
        const cd = state.cooldowns && state.cooldowns[type];
        if (!cd) continue;
        const total = (cd.ms != null) ? cd.ms : BASE_HUNT_COOLDOWN_MS;
        const readyAt = cd.readyAt || 0;
        if (total === 0 || now >= readyAt) {
          b.style.setProperty('--cdw', '0%');
          b.disabled = false;
        } else {
          const elapsed = Math.max(0, total - (readyAt - now));
          const pct = Math.max(0, Math.min(1, elapsed / total));
          b.style.setProperty('--cdw', (pct * 100).toFixed(1) + '%');
          b.disabled = true;
          anyCooling = true;
        }
      }
      if (anyCooling) requestAnimationFrame(updateCooldownVisual);
    }

    let autosaveEnabled = true;
    let autosaveId = setInterval(autosave, 30_000);
    function autosave() {
      if (!autosaveEnabled) return;
      save();
      lastSaveTime = Date.now();
      updateLastSaved();
      showAutosaveToast();
    }

    // Autosave toggle button functionality
    const autosaveToggleBtn = document.getElementById("autosaveToggleBtn");
    if (autosaveToggleBtn) {
      autosaveToggleBtn.addEventListener("click", () => {
        autosaveEnabled = !autosaveEnabled;
        autosaveToggleBtn.textContent = autosaveEnabled ? "Autosave ON" : "Autosave OFF";
        if (autosaveEnabled && !autosaveId) {
          autosaveId = setInterval(autosave, 30_000);
        } else if (!autosaveEnabled && autosaveId) {
          clearInterval(autosaveId);
          autosaveId = null;
        }
      });
    }

    // Save when tab is hidden, unless we are resetting
    const onVis = () => {
      if (document.hidden && !suppressSaves) save();
    };
    document.addEventListener("visibilitychange", onVis);

    // Manual Save button functionality
    const manualSaveBtn = document.getElementById("manualSaveBtn");
    if (manualSaveBtn) {
      manualSaveBtn.addEventListener("click", () => {
        save();
        lastSaveTime = Date.now();
        updateLastSaved();
        showManualSaveToast();
      });
    }



    // Reset Save button functionality with 3-press failsafe
    const resetBtn = document.getElementById("resetBtn");
    let resetPressCount = 0;
    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        resetPressCount++;
        if (resetPressCount < 3) {
          resetBtn.textContent = `Reset Save (${3 - resetPressCount} more)`;
          setTimeout(() => {
            resetPressCount = 0;
            resetBtn.textContent = "Reset Save";
          }, 2000);
          return;
        }
        // Block any further saves, stop timers, and unbind handlers
        suppressSaves = true;
        document.removeEventListener("visibilitychange", onVis);
        clearInterval(autosaveId);
        clearInterval(tickId);

        // Remove save and legacy flags, then reload
        localStorage.removeItem(SAVE_KEY);
        // Clean up legacy key so unlock does not persist through resets
        localStorage.removeItem("contractsUnlocked");
        location.reload();
      });
    }

    // Window resize listener to update mobile classes
    window.addEventListener('resize', () => {
      // Update upgrade rows with mobile class if needed
      const upgradeRows = document.querySelectorAll('.upgrade-row');
      upgradeRows.forEach(row => {
        if (window.innerWidth <= 768) {
          row.classList.add('upgrade-row-mobile');
        } else {
          row.classList.remove('upgrade-row-mobile');
        }
      });
    });
  </script>
  </body>
</html>
